---
title: 2025å¹´12æœˆã®å­¦ç¿’ãƒ¡ãƒ¢ - K8Sã¡ã‚‡ã£ã¨ã€AWS DVAé–¢é€£(API Gateway, Lambda, etc)
publish_date: 2025-12-26
tags: [tech k8s aws apigateway lambda]
draft: false
bsky_url: 
---

## æ¦‚è¦

2025å¹´12æœˆã®æŠ€è¡“ãƒ»å­¦ç¿’ãƒ¡ãƒ¢ã€‚

ä»¥ä¸‹ç›®æ¬¡ã€‚

## ğŸš¢ Kubernetes 

[ã¤ãã£ã¦ã€å£Šã—ã¦ã€ç›´ã—ã¦å­¦ã¶ Kuberneteså…¥é–€](https://amzn.to/4c22Caf)ã®11ç« ã‹ã‚‰èª­ã‚“ã§ã„ãã€‚

### 11ç«  ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ã¨ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

#### ã‚ªãƒ–ã‚¶ãƒ¼ãƒãƒ“ãƒªãƒ†ã‚£ã¨ã¯

5ã¤ã®ã‚·ã‚°ãƒŠãƒ«ã‚’æ´»ç”¨ã™ã‚‹ã¨ã‚ˆãã€ã¾ãšã¯å‰åŠä¸‰ã¤ã‹ã‚‰ä½¿ã†ã¨è‰¯ã„ã€‚

- Logs
- Metrics
- Traces
- Profiles
- Dumps

##### Logs

è¨€ã‚ãšã¨ã—ã‚ŒãŸãƒ­ã‚°ã€‚k8sã«ã‚‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒ­ã‚°æ©Ÿèƒ½ãŒå‚™ã‚ã£ã¦ã„ã¦ã€`kubectl logs`ã‚‚ãã®ä»•çµ„ã¿ã€‚ã—ã‹ã—PodãŒå‰Šé™¤ã•ã‚Œã‚‹ãªã©ã™ã‚‹ã¨ãƒ­ã‚°ã‚‚ä¸€ç·’ã«å‰Šé™¤ã•ã‚Œã‚‹ãŸã‚ã€æœ¬ç•ªé‹ç”¨ã«ã‚ãŸã£ã¦ã¯æ°¸ç¶šåŒ–ã®ä»•çµ„ã¿ã‚’å–ã‚Šå…¥ã‚Œã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

Fluentd, Fluentbit, Grafana Lokiãªã©ã€ãƒ­ã‚°è»¢é€ã¨ãƒ­ã‚°åé›†ãƒ»æ¤œç´¢ã‚’å¯èƒ½ã«ã™ã‚‹OSSãŒã‚ã‚‹ã€‚

##### Metrics

ã“ã¡ã‚‰ã‚‚ã”å­˜çŸ¥ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã€‚æ¸¬å®šå€¤ã‚’ä½¿ç”¨ã—ã¦çµ±è¨ˆçš„ãªå‡¦ç†ãƒ»åˆ†æã‚’è¡Œã†ã®ã«æœ‰ç”¨ã€‚k8sã«ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã¯åé›†æ©Ÿèƒ½ãŒãªã„ãŸã‚ã€å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’åˆ©ç”¨ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

æ˜¨ä»Šã ã¨Prometheusã€‚

##### Traces

è€³æ…£ã‚Œãªã„å˜èªã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãªã„ã—ã¯ã‚¢ãƒ—ãƒªã®é€šä¿¡ã‚’è¿½è·¡ã™ã‚‹ãŸã‚ã®æ¦‚å¿µã€‚æ“ä½œ(Span)ã®é›†åˆã‹ã‚‰æˆã‚‹ã€‚è¤‡æ•°ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’çµŒç”±ã™ã‚‹ã‚ˆã†ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆã€ã©ã®ã‚³ãƒ³ãƒ†ãƒŠãŒåŸå› ã‹ã‚’è¾¿ã‚‹éš›ã«æœ‰ç”¨ã€‚ã¾ãŸã€å„Spanã§ã©ã‚Œã ã‘æ™‚é–“ãŒã‹ã‹ã£ãŸã®ã‹ã‚‚ç´°ã‹ãå¯è¦–åŒ–ã§ãã‚‹ã€‚

ãŸã ã—ã€æ­£ç¢ºãªæƒ…å ±ã‚’åé›†ã™ã‚‹ãŸã‚ã«çµŒè·¯ä¸Šå…¨ã¦ã‚’ç¶²ç¾…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŸã‚ã€å°å…¥ã®ãƒãƒ¼ãƒ‰ãƒ«ã¯é«˜ã‚ã€‚

ã‚¢ãƒ—ãƒªå†…ã§Traceã¨Spanã‚’å®Ÿè£…ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ãŒã€ãã®éš›ã«å½¹ç«‹ã¤OSSã¨ã„ã¦OpenTelemetryãŒã‚ã‚‹ã€‚ã¾ãŸã€åé›†ã§ã¯Jaegerã‚„Grafana Tempoãªã©ãŒã‚ã‚‹ã€‚

#### ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã«ã¤ã„ã¦

ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã¯ä»¥ä¸‹ã®è¦ç´ ã§æ§‹æˆã•ã‚Œã‚‹ã€‚

- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
  - åé›†ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’è¦³æ¸¬å¯èƒ½ã«ã™ã‚‹ã‚ˆã†ã«å¯è¦–åŒ–ã™ã‚‹ã€‚GrafanaãŒè©²å½“ã€‚
- ã‚¢ãƒ©ãƒ¼ãƒˆ
  - ç•°å¸¸ã‚’çŸ¥ã‚‰ã›ã‚‹æ©Ÿèƒ½ã€‚Metricsã‚’å…ƒã«é–¾å€¤ã‚’è¨­å®šã—ã€å¾ã€…ã«ã‚«ã‚¹ã‚¿ãƒ ã—ã¦ã„ãã®ãŒã‚ˆã„ã€‚Prometheusã®AlertManagerã€‚

#### ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ç”¨ã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰

Prometheusã¨Grafanaã‚’ä½¿ã£ã¦ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ç”¨ã‚·ã‚¹ãƒ†ãƒ ã‚’æ§‹ç¯‰ã—ã¦ã¿ã‚‹ã€‚Metricsåé›†ã¨ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ã‚ˆã‚‹å¯è¦–åŒ–ã®ã¿ã€‚

è©³ç´°ã¯æœ¬ã‚’è²·ã£ã¦ã­ã€‚Helmã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ãŸå¾Œã®Podã®çŠ¶æ³ã€‚

```bash
$ kubectl get pod -n monitoring
NAME                                                        READY   STATUS    RESTARTS   AGE
alertmanager-kube-prometheus-stack-alertmanager-0           2/2     Running   0          92s
kube-prometheus-stack-grafana-cd79f9f9b-6r79j               2/3     Running   0          110s
kube-prometheus-stack-kube-state-metrics-7c7ff6864c-7pzt7   1/1     Running   0          110s
kube-prometheus-stack-operator-f8496f5f8-t4q5s              1/1     Running   0          110s
kube-prometheus-stack-prometheus-node-exporter-5cpbw        1/1     Running   0          110s
kube-prometheus-stack-prometheus-node-exporter-5cps8        1/1     Running   0          110s
kube-prometheus-stack-prometheus-node-exporter-jhc5x        1/1     Running   0          110s
prometheus-kube-prometheus-stack-prometheus-0               2/2     Running   0          91s
```

ã†ã¡ã®ãƒ©ã‚ºãƒ‘ã‚¤ãŸã¡ãŒæ‚²é³´ã‚’ã‚ã’ã¦ã‚‹ã€‚

ãƒ¡ãƒˆãƒªã‚¯ã‚¹åé›†å¯¾è±¡ã®ã‚¢ãƒ—ãƒªã‚’ç«‹ã¡ä¸Šã’ã‚‹ã€‚å…ƒã«ãªã‚‹ãƒãƒ‹ãƒ¥ãƒ•ã‚§ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯ä½œè€…ãŒå…¬é–‹ã—ã¦ã„ã‚‹[Githubãƒªãƒã‚¸ãƒˆãƒª](https://github.com/aoi1/bbf-kubernetes)ã«ã‚ã‚‹ã€‚

```bash
$ kubectl apply --filename chapter-11/namespace.yaml
namespace/develop created
$ kubectl apply --filename chapter-11/hello-server.yaml
deployment.apps/hello-server created
service/hello-server created
$ kubectl get pod -n develop
NAME                           READY   STATUS    RESTARTS   AGE
hello-server-6949fbcb8-6wnlt   1/1     Running   0          25s
hello-server-6949fbcb8-d8p9k   1/1     Running   0          25s
hello-server-6949fbcb8-r8cbp   1/1     Running   0          25s
```

æ¬¡ã«ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã‚’åé›†ã™ã‚‹ãŸã‚ã®è¨­å®šã‚’Prometheusã«å…¥ã‚Œè¾¼ã‚€ã€‚

```bash
$ helm upgrade kube-prometheus-stack -f kube-prometheus-stack/values.yaml prometheus-c
ommunity/kube-prometheus-stack -n monitoring
level=WARN msg="unable to find exact version; falling back to closest available version" chart=kube-prometheus-sta
ck requested="" selected=79.10.0
Release "kube-prometheus-stack" has been upgraded. Happy Helming!
NAME: kube-prometheus-stack
LAST DEPLOYED: Tue Dec  2 23:19:54 2025
NAMESPACE: monitoring
STATUS: deployed
REVISION: 3
DESCRIPTION: Upgrade complete
```

ãƒãƒ¼ãƒˆãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã—ã¦UIã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã‚‹ã€‚

```bash
$ kubectl port-forward services/kube-prometheus-stack-prometheus -n monitoring 9090:90
90
Forwarding from 127.0.0.1:9090 -> 9090
Forwarding from [::1]:9090 -> 9090
```

å®Ÿéš›ã«Webãƒ–ãƒ©ã‚¦ã‚¶ã§`localhost:9090`ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨Prometheusã®ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ãŒç¢ºèªã§ãã€`hello-server`ã®ãƒ¡ãƒˆãƒªãƒƒã‚¯ãŒåé›†ã§ãã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã‚‹ã€‚

åŒæ§˜ã«Grafanaã«ã‚‚ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã¿ã‚‹ã€‚

```bash
$ kubectl port-forward service/kube-prometheus-stack-grafana -n monitoring 8081:80
```

åˆ¥ã§å‹•ã‹ã—ã¦ã„ã‚‹Zabbixã®ãƒãƒ¼ãƒˆã¨è¢«ã‚‹ã®ã§`8081`ã«å¤‰æ›´ã€‚åˆæœŸãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å¤‰ã‚ã£ã¦ã„ã‚‹ã‚ˆã†ãªã®ã§ç¢ºèªã™ã‚‹ã€‚

```bash
$ kubectl get secret kube-prometheus-stack-grafana -o json "{.data.admin-password}" -n monitoring | base64 --decode
```

![Grafana](https://d3toh8on7lf5va.cloudfront.net/grafana.jpg)

Prometheusã¨Grafanaã¯åˆ¥é€”å‹‰å¼·ã—ãŸã„ãªãã€‚

## â˜ï¸ AWS
